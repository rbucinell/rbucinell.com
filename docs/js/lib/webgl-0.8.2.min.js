this.createjs=this.createjs||{},function(){"use strict";function t(t){this.Container_constructor(),this.spriteSheet=t}var e=createjs.extend(t,createjs.Container);e.addChild=function(t){return null==t?t:1<arguments.length?this.addChildAt.apply(this,Array.prototype.slice.call(arguments).concat([this.children.length])):this.addChildAt(t,this.children.length)},e.addChildAt=function(t,e){var i=arguments.length,r=arguments[i-1];if(r<0||r>this.children.length)return arguments[i-2];if(2<i){for(var a=0;a<i-1;a++)this.addChildAt(arguments[a],r+a);return arguments[i-2]}if(!(1<=t._spritestage_compatibility))return console&&console.log("Error: You can only add children of type SpriteContainer, Sprite, BitmapText, or DOMElement ["+t.toString()+"]"),t;if(t._spritestage_compatibility<=4){var s=t.spriteSheet;if(!s||!s._images||1<s._images.length||this.spriteSheet&&this.spriteSheet!==s)return console&&console.log("Error: A child's spriteSheet must be equal to its parent spriteSheet and only use one image. ["+t.toString()+"]"),t;this.spriteSheet=s}return t.parent&&t.parent.removeChild(t),(t.parent=this).children.splice(e,0,t),t},e.toString=function(){return"[SpriteContainer (name="+this.name+")]"},createjs.SpriteContainer=createjs.promote(t,"Container")}(),this.createjs=this.createjs||{},function(){"use strict";function D(t,e,i){this.Stage_constructor(t),this._preserveDrawingBuffer=e||!1,this._antialias=i||!1,this._viewportWidth=0,this._viewportHeight=0,this._projectionMatrix=null,this._webGLContext=null,this._webGLErrorDetected=!1,this._clearColor=null,this._maxTexturesPerDraw=1,this._maxBoxesPointsPerDraw=null,this._maxBoxesPerDraw=null,this._maxIndicesPerDraw=null,this._shaderProgram=null,this._vertices=null,this._verticesBuffer=null,this._indices=null,this._indicesBuffer=null,this._currentBoxIndex=-1,this._drawTexture=null,this._initializeWebGL()}[createjs.SpriteContainer,createjs.Sprite,createjs.BitmapText,createjs.Bitmap,createjs.DOMElement].forEach(function(t,e){t.prototype._spritestage_compatibility=e+1});var t=createjs.extend(D,createjs.Stage);D.NUM_VERTEX_PROPERTIES=5,D.NUM_VERTEX_PROPERTIES_PER_BOX=(D.POINTS_PER_BOX=4)*D.NUM_VERTEX_PROPERTIES,D.INDICES_PER_BOX=6,D.MAX_INDEX_SIZE=Math.pow(2,16),D.MAX_BOXES_POINTS_INCREMENT=D.MAX_INDEX_SIZE/4,t._get_isWebGL=function(){return!!this._webGLContext};try{Object.defineProperties(t,{isWebGL:{get:t._get_isWebGL}})}catch(t){}t.addChild=function(t){return null==t?t:1<arguments.length?this.addChildAt.apply(this,Array.prototype.slice.call(arguments).concat([this.children.length])):this.addChildAt(t,this.children.length)},t.addChildAt=function(t,e){var i=arguments.length,r=arguments[i-1];if(r<0||r>this.children.length)return arguments[i-2];if(2<i){for(var a=0;a<i-1;a++)this.addChildAt(arguments[a],r+a);return arguments[i-2]}return 1<=t._spritestage_compatibility?!t.image&&!t.spriteSheet&&t._spritestage_compatibility<=4?console&&console.log("Error: You can only add children that have an image or spriteSheet defined on them. ["+t.toString()+"]"):(t.parent&&t.parent.removeChild(t),(t.parent=this).children.splice(e,0,t)):console&&console.log("Error: You can only add children of type SpriteContainer, Sprite, Bitmap, BitmapText, or DOMElement. ["+t.toString()+"]"),t},t.update=function(t){if(this.canvas){this.tickOnUpdate&&this.tick(t),this.dispatchEvent("drawstart"),this.autoClear&&this.clear();var e=this._setWebGLContext();e?this.draw(e,!1):((e=this.canvas.getContext("2d")).save(),this.updateContext(e),this.draw(e,!1),e.restore()),this.dispatchEvent("drawend")}},t.clear=function(){if(this.canvas){var t=this._setWebGLContext();t?t.clear(t.COLOR_BUFFER_BIT):((t=this.canvas.getContext("2d")).setTransform(1,0,0,1,0,0),t.clearRect(0,0,this.canvas.width+1,this.canvas.height+1))}},t.draw=function(t,e){return"undefined"!=typeof WebGLRenderingContext&&(t===this._webGLContext||t instanceof WebGLRenderingContext)?(this._drawWebGLKids(this.children,t),!0):this.Stage_draw(t,e)},t.updateViewport=function(t,e){this._viewportWidth=t,this._viewportHeight=e,this._webGLContext&&(this._webGLContext.viewport(0,0,this._viewportWidth,this._viewportHeight),this._projectionMatrix||(this._projectionMatrix=new Float32Array([0,0,0,0,0,1,-1,1,1])),this._projectionMatrix[0]=2/t,this._projectionMatrix[4]=-2/e)},t.clearImageTexture=function(t){t.__easeljs_texture=null},t.toString=function(){return"[SpriteStage (name="+this.name+")]"},t._initializeWebGL=function(){this._clearColor={r:0,g:0,b:0,a:0},this._setWebGLContext()},t._setWebGLContext=function(){return this.canvas?this._webGLContext&&this._webGLContext.canvas===this.canvas||this._initializeWebGLContext():this._webGLContext=null,this._webGLContext},t._initializeWebGLContext=function(){var t={depth:!1,alpha:!0,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias,premultipliedAlpha:!0},e=this._webGLContext=this.canvas.getContext("webgl",t)||this.canvas.getContext("experimental-webgl",t);if(e){if(this._maxTexturesPerDraw=1,this._setClearColor(this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a),e.enable(e.BLEND),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),this._createShaderProgram(e),this._webGLErrorDetected)return void(this._webGLContext=null);this._createBuffers(e),this.updateViewport(this._viewportWidth||this.canvas.width||0,this._viewportHeight||this.canvas.height||0)}},t._setClearColor=function(t,e,i,r){this._clearColor.r=t,this._clearColor.g=e,this._clearColor.b=i,this._clearColor.a=r,this._webGLContext&&this._webGLContext.clearColor(t,e,i,r)},t._createShaderProgram=function(t){var e=this._createShader(t,t.FRAGMENT_SHADER,"precision mediump float;uniform sampler2D uSampler0;varying vec3 vTextureCoord;void main(void) {vec4 color = texture2D(uSampler0, vTextureCoord.st);gl_FragColor = vec4(color.rgb, color.a * vTextureCoord.z);}"),i=this._createShader(t,t.VERTEX_SHADER,"attribute vec2 aVertexPosition;attribute vec3 aTextureCoord;uniform mat3 uPMatrix;varying vec3 vTextureCoord;void main(void) {vTextureCoord = aTextureCoord;gl_Position = vec4((uPMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);}");if(!this._webGLErrorDetected&&e&&i){var r=t.createProgram();if(t.attachShader(r,e),t.attachShader(r,i),t.linkProgram(r),!t.getProgramParameter(r,t.LINK_STATUS))return void(this._webGLErrorDetected=!0);r.vertexPositionAttribute=t.getAttribLocation(r,"aVertexPosition"),r.textureCoordAttribute=t.getAttribLocation(r,"aTextureCoord"),r.sampler0uniform=t.getUniformLocation(r,"uSampler0"),t.enableVertexAttribArray(r.vertexPositionAttribute),t.enableVertexAttribArray(r.textureCoordAttribute),r.pMatrixUniform=t.getUniformLocation(r,"uPMatrix"),t.useProgram(r),this._shaderProgram=r}},t._createShader=function(t,e,i){var r=t.createShader(e);return t.shaderSource(r,i),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS)?r:(this._webGLErrorDetected=!0,null)},t._createBuffers=function(t){this._verticesBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._verticesBuffer);var e=4*D.NUM_VERTEX_PROPERTIES;t.vertexAttribPointer(this._shaderProgram.vertexPositionAttribute,2,t.FLOAT,t.FALSE,e,0),t.vertexAttribPointer(this._shaderProgram.textureCoordAttribute,3,t.FLOAT,t.FALSE,e,8),this._indicesBuffer=t.createBuffer(),this._setMaxBoxesPoints(t,D.MAX_BOXES_POINTS_INCREMENT)},t._setMaxBoxesPoints=function(t,e){this._maxBoxesPointsPerDraw=e,this._maxBoxesPerDraw=this._maxBoxesPointsPerDraw/D.POINTS_PER_BOX|0,this._maxIndicesPerDraw=this._maxBoxesPerDraw*D.INDICES_PER_BOX,t.bindBuffer(t.ARRAY_BUFFER,this._verticesBuffer),this._vertices=new Float32Array(this._maxBoxesPerDraw*D.NUM_VERTEX_PROPERTIES_PER_BOX),t.bufferData(t.ARRAY_BUFFER,this._vertices,t.DYNAMIC_DRAW),this._indices=new Uint16Array(this._maxIndicesPerDraw);for(var i=0,r=this._indices.length;i<r;i+=D.INDICES_PER_BOX){var a=i*D.POINTS_PER_BOX/D.INDICES_PER_BOX;this._indices[i]=a,this._indices[i+1]=a+1,this._indices[i+2]=a+2,this._indices[i+3]=a,this._indices[i+4]=a+2,this._indices[i+5]=a+3}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._indicesBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this._indices,t.STATIC_DRAW)},t._setupImageTexture=function(t,e){if(e&&(e.naturalWidth||e.getContext||2<=e.readyState)){var i=e.__easeljs_texture;return i||(i=e.__easeljs_texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)),i}},t._drawWebGLKids=function(t,e,i){for(var r,a,s=this.snapToPixelEnabled,n=null,o=0,h=0,_=0,c=0,l=this._vertices,d=D.NUM_VERTEX_PROPERTIES_PER_BOX,u=D.MAX_INDEX_SIZE,x=this._maxBoxesPerDraw-1,E=0,p=t.length;E<p;E++)if((r=t[E]).isVisible()){var f=(n=r.image||r.spriteSheet&&r.spriteSheet._images[0]).__easeljs_texture;if(f||(f=this._setupImageTexture(e,n))){a=r._props.matrix,a=(i?a.copy(i):a.identity()).appendTransform(r.x,r.y,r.scaleX,r.scaleY,r.rotation,r.skewX,r.skewY,r.regX,r.regY);var g=0,T=1,m=0,P=1;if(4===r._spritestage_compatibility)h=o=0,_=n.width,c=n.height;else if(2===r._spritestage_compatibility){var S=r.spriteSheet.getFrame(r.currentFrame),C=S.rect;o=-S.regX,h=-S.regY,_=o+C.width,c=h+C.height,g=C.x/n.width,m=C.y/n.height,T=g+C.width/n.width,P=m+C.height/n.height}else n=null,3===r._spritestage_compatibility&&r._updateText();if(!i&&r._spritestage_compatibility<=4&&f!==this._drawTexture&&(this._drawToGPU(e),this._drawTexture=f),null!==n){var R=++this._currentBoxIndex*d,v=a.a,w=a.b,b=a.c,A=a.d,B=a.tx,L=a.ty;s&&r.snapToPixel&&(B=B+(B<0?-.5:.5)|0,L=L+(L<0?-.5:.5)|0),l[R]=o*v+h*b+B,l[R+1]=o*w+h*A+L,l[R+5]=o*v+c*b+B,l[R+6]=o*w+c*A+L,l[R+10]=_*v+c*b+B,l[R+11]=_*w+c*A+L,l[R+15]=_*v+h*b+B,l[R+16]=_*w+h*A+L,l[R+2]=l[R+7]=g,l[R+12]=l[R+17]=T,l[R+3]=l[R+18]=m,l[R+8]=l[R+13]=P,l[R+4]=l[R+9]=l[R+14]=l[R+19]=r.alpha,this._currentBoxIndex===x&&(this._drawToGPU(e),this._drawTexture=f,this._maxBoxesPointsPerDraw<u&&(this._setMaxBoxesPoints(e,this._maxBoxesPointsPerDraw+D.MAX_BOXES_POINTS_INCREMENT),x=this._maxBoxesPerDraw-1))}r.children&&(this._drawWebGLKids(r.children,e,a),x=this._maxBoxesPerDraw-1)}}i||this._drawToGPU(e)},t._drawToGPU=function(t){if(this._drawTexture){var e=this._currentBoxIndex+1;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._drawTexture),t.uniform1i(this._shaderProgram.sampler0uniform,0),t.bindBuffer(t.ARRAY_BUFFER,this._verticesBuffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._indicesBuffer),t.uniformMatrix3fv(this._shaderProgram.pMatrixUniform,!1,this._projectionMatrix),t.bufferSubData(t.ARRAY_BUFFER,0,this._vertices),t.drawElements(t.TRIANGLES,e*D.INDICES_PER_BOX,t.UNSIGNED_SHORT,0),this._currentBoxIndex=-1,this._drawTexture=null}},createjs.SpriteStage=createjs.promote(D,"Stage")}();