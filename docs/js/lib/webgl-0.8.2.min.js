this.createjs=this.createjs||{},function(){"use strict";function t(t){this.Container_constructor(),this.spriteSheet=t}var e=createjs.extend(t,createjs.Container);e.addChild=function(t){return null==t?t:1<arguments.length?this.addChildAt.apply(this,Array.prototype.slice.call(arguments).concat([this.children.length])):this.addChildAt(t,this.children.length)},e.addChildAt=function(t,e){var i=arguments.length,r=arguments[i-1];if(r<0||r>this.children.length)return arguments[i-2];if(2<i){for(var a=0;a<i-1;a++)this.addChildAt(arguments[a],r+a);return arguments[i-2]}if(!(1<=t._spritestage_compatibility))return console&&console.log("Error: You can only add children of type SpriteContainer, Sprite, BitmapText, or DOMElement ["+t.toString()+"]"),t;if(t._spritestage_compatibility<=4){var s=t.spriteSheet;if(!s||!s._images||1<s._images.length||this.spriteSheet&&this.spriteSheet!==s)return console&&console.log("Error: A child's spriteSheet must be equal to its parent spriteSheet and only use one image. ["+t.toString()+"]"),t;this.spriteSheet=s}return t.parent&&t.parent.removeChild(t),(t.parent=this).children.splice(e,0,t),t},e.toString=function(){return"[SpriteContainer (name="+this.name+")]"},createjs.SpriteContainer=createjs.promote(t,"Container")}(),this.createjs=this.createjs||{},function(){"use strict";function B(t,e,i){this.Stage_constructor(t),this._preserveDrawingBuffer=e||!1,this._antialias=i||!1,this._viewportWidth=0,this._viewportHeight=0,this._projectionMatrix=null,this._webGLContext=null,this._webGLErrorDetected=!1,this._clearColor=null,this._maxTexturesPerDraw=1,this._maxBoxesPointsPerDraw=null,this._maxBoxesPerDraw=null,this._maxIndicesPerDraw=null,this._shaderProgram=null,this._vertices=null,this._verticesBuffer=null,this._indices=null,this._indicesBuffer=null,this._currentBoxIndex=-1,this._drawTexture=null,this._initializeWebGL()}[createjs.SpriteContainer,createjs.Sprite,createjs.BitmapText,createjs.Bitmap,createjs.DOMElement].forEach(function(t,e){t.prototype._spritestage_compatibility=e+1});var t=createjs.extend(B,createjs.Stage);B.NUM_VERTEX_PROPERTIES=5,B.NUM_VERTEX_PROPERTIES_PER_BOX=(B.POINTS_PER_BOX=4)*B.NUM_VERTEX_PROPERTIES,B.INDICES_PER_BOX=6,B.MAX_INDEX_SIZE=Math.pow(2,16),B.MAX_BOXES_POINTS_INCREMENT=B.MAX_INDEX_SIZE/4,t._get_isWebGL=function(){return!!this._webGLContext};try{Object.defineProperties(t,{isWebGL:{get:t._get_isWebGL}})}catch(t){}t.addChild=function(t){return null==t?t:1<arguments.length?this.addChildAt.apply(this,Array.prototype.slice.call(arguments).concat([this.children.length])):this.addChildAt(t,this.children.length)},t.addChildAt=function(t,e){var i=arguments.length,r=arguments[i-1];if(r<0||r>this.children.length)return arguments[i-2];if(2<i){for(var a=0;a<i-1;a++)this.addChildAt(arguments[a],r+a);return arguments[i-2]}return 1<=t._spritestage_compatibility?!t.image&&!t.spriteSheet&&t._spritestage_compatibility<=4?console&&console.log("Error: You can only add children that have an image or spriteSheet defined on them. ["+t.toString()+"]"):(t.parent&&t.parent.removeChild(t),(t.parent=this).children.splice(e,0,t)):console&&console.log("Error: You can only add children of type SpriteContainer, Sprite, Bitmap, BitmapText, or DOMElement. ["+t.toString()+"]"),t},t.update=function(t){this.canvas&&(this.tickOnUpdate&&this.tick(t),this.dispatchEvent("drawstart"),this.autoClear&&this.clear(),(t=this._setWebGLContext())?this.draw(t,!1):((t=this.canvas.getContext("2d")).save(),this.updateContext(t),this.draw(t,!1),t.restore()),this.dispatchEvent("drawend"))},t.clear=function(){var t;this.canvas&&((t=this._setWebGLContext())?t.clear(t.COLOR_BUFFER_BIT):((t=this.canvas.getContext("2d")).setTransform(1,0,0,1,0,0),t.clearRect(0,0,this.canvas.width+1,this.canvas.height+1)))},t.draw=function(t,e){return"undefined"!=typeof WebGLRenderingContext&&(t===this._webGLContext||t instanceof WebGLRenderingContext)?(this._drawWebGLKids(this.children,t),!0):this.Stage_draw(t,e)},t.updateViewport=function(t,e){this._viewportWidth=t,this._viewportHeight=e,this._webGLContext&&(this._webGLContext.viewport(0,0,this._viewportWidth,this._viewportHeight),this._projectionMatrix||(this._projectionMatrix=new Float32Array([0,0,0,0,0,1,-1,1,1])),this._projectionMatrix[0]=2/t,this._projectionMatrix[4]=-2/e)},t.clearImageTexture=function(t){t.__easeljs_texture=null},t.toString=function(){return"[SpriteStage (name="+this.name+")]"},t._initializeWebGL=function(){this._clearColor={r:0,g:0,b:0,a:0},this._setWebGLContext()},t._setWebGLContext=function(){return this.canvas?this._webGLContext&&this._webGLContext.canvas===this.canvas||this._initializeWebGLContext():this._webGLContext=null,this._webGLContext},t._initializeWebGLContext=function(){var t={depth:!1,alpha:!0,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias,premultipliedAlpha:!0},t=this._webGLContext=this.canvas.getContext("webgl",t)||this.canvas.getContext("experimental-webgl",t);t&&(this._maxTexturesPerDraw=1,this._setClearColor(this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a),t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),this._createShaderProgram(t),this._webGLErrorDetected?this._webGLContext=null:(this._createBuffers(t),this.updateViewport(this._viewportWidth||this.canvas.width||0,this._viewportHeight||this.canvas.height||0)))},t._setClearColor=function(t,e,i,r){this._clearColor.r=t,this._clearColor.g=e,this._clearColor.b=i,this._clearColor.a=r,this._webGLContext&&this._webGLContext.clearColor(t,e,i,r)},t._createShaderProgram=function(t){var e,i=this._createShader(t,t.FRAGMENT_SHADER,"precision mediump float;uniform sampler2D uSampler0;varying vec3 vTextureCoord;void main(void) {vec4 color = texture2D(uSampler0, vTextureCoord.st);gl_FragColor = vec4(color.rgb, color.a * vTextureCoord.z);}"),r=this._createShader(t,t.VERTEX_SHADER,"attribute vec2 aVertexPosition;attribute vec3 aTextureCoord;uniform mat3 uPMatrix;varying vec3 vTextureCoord;void main(void) {vTextureCoord = aTextureCoord;gl_Position = vec4((uPMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);}");!this._webGLErrorDetected&&i&&r&&(e=t.createProgram(),t.attachShader(e,i),t.attachShader(e,r),t.linkProgram(e),t.getProgramParameter(e,t.LINK_STATUS)?(e.vertexPositionAttribute=t.getAttribLocation(e,"aVertexPosition"),e.textureCoordAttribute=t.getAttribLocation(e,"aTextureCoord"),e.sampler0uniform=t.getUniformLocation(e,"uSampler0"),t.enableVertexAttribArray(e.vertexPositionAttribute),t.enableVertexAttribArray(e.textureCoordAttribute),e.pMatrixUniform=t.getUniformLocation(e,"uPMatrix"),t.useProgram(e),this._shaderProgram=e):this._webGLErrorDetected=!0)},t._createShader=function(t,e,i){e=t.createShader(e);return t.shaderSource(e,i),t.compileShader(e),t.getShaderParameter(e,t.COMPILE_STATUS)?e:(this._webGLErrorDetected=!0,null)},t._createBuffers=function(t){this._verticesBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._verticesBuffer);var e=4*B.NUM_VERTEX_PROPERTIES;t.vertexAttribPointer(this._shaderProgram.vertexPositionAttribute,2,t.FLOAT,t.FALSE,e,0),t.vertexAttribPointer(this._shaderProgram.textureCoordAttribute,3,t.FLOAT,t.FALSE,e,8),this._indicesBuffer=t.createBuffer(),this._setMaxBoxesPoints(t,B.MAX_BOXES_POINTS_INCREMENT)},t._setMaxBoxesPoints=function(t,e){this._maxBoxesPointsPerDraw=e,this._maxBoxesPerDraw=this._maxBoxesPointsPerDraw/B.POINTS_PER_BOX|0,this._maxIndicesPerDraw=this._maxBoxesPerDraw*B.INDICES_PER_BOX,t.bindBuffer(t.ARRAY_BUFFER,this._verticesBuffer),this._vertices=new Float32Array(this._maxBoxesPerDraw*B.NUM_VERTEX_PROPERTIES_PER_BOX),t.bufferData(t.ARRAY_BUFFER,this._vertices,t.DYNAMIC_DRAW),this._indices=new Uint16Array(this._maxIndicesPerDraw);for(var i=0,r=this._indices.length;i<r;i+=B.INDICES_PER_BOX){var a=i*B.POINTS_PER_BOX/B.INDICES_PER_BOX;this._indices[i]=a,this._indices[i+1]=1+a,this._indices[i+2]=2+a,this._indices[i+3]=a,this._indices[i+4]=2+a,this._indices[i+5]=3+a}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._indicesBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this._indices,t.STATIC_DRAW)},t._setupImageTexture=function(t,e){var i;if(e&&(e.naturalWidth||e.getContext||2<=e.readyState))return(i=e.__easeljs_texture)||(i=e.__easeljs_texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)),i},t._drawWebGLKids=function(t,e,i){for(var r,a,s,n,o,h,_,c,l,d,u,x,E,p,f=this.snapToPixelEnabled,g=null,T=0,m=0,P=0,S=0,C=this._vertices,R=B.NUM_VERTEX_PROPERTIES_PER_BOX,w=B.MAX_INDEX_SIZE,b=this._maxBoxesPerDraw-1,v=0,A=t.length;v<A;v++)(p=t[v]).isVisible()&&(r=(r=(g=p.image||p.spriteSheet&&p.spriteSheet._images[0]).__easeljs_texture)||this._setupImageTexture(e,g))&&(a=p._props.matrix,a=(i?a.copy(i):a.identity()).appendTransform(p.x,p.y,p.scaleX,p.scaleY,p.rotation,p.skewX,p.skewY,p.regX,p.regY),n=s=0,h=o=1,4===p._spritestage_compatibility?(m=T=0,P=g.width,S=g.height):2===p._spritestage_compatibility?(c=(_=p.spriteSheet.getFrame(p.currentFrame)).rect,T=-_.regX,m=-_.regY,P=T+c.width,S=m+c.height,s=c.x/g.width,n=c.y/g.height,o=s+c.width/g.width,h=n+c.height/g.height):(g=null,3===p._spritestage_compatibility&&p._updateText()),!i&&p._spritestage_compatibility<=4&&r!==this._drawTexture&&(this._drawToGPU(e),this._drawTexture=r),null!==g&&(_=++this._currentBoxIndex*R,c=a.a,l=a.b,d=a.c,u=a.d,x=a.tx,E=a.ty,f&&p.snapToPixel&&(x=x+(x<0?-.5:.5)|0,E=E+(E<0?-.5:.5)|0),C[_]=T*c+m*d+x,C[1+_]=T*l+m*u+E,C[5+_]=T*c+S*d+x,C[6+_]=T*l+S*u+E,C[10+_]=P*c+S*d+x,C[11+_]=P*l+S*u+E,C[15+_]=P*c+m*d+x,C[16+_]=P*l+m*u+E,C[2+_]=C[7+_]=s,C[12+_]=C[17+_]=o,C[3+_]=C[18+_]=n,C[8+_]=C[13+_]=h,C[4+_]=C[9+_]=C[14+_]=C[19+_]=p.alpha,this._currentBoxIndex===b&&(this._drawToGPU(e),this._drawTexture=r,this._maxBoxesPointsPerDraw<w&&(this._setMaxBoxesPoints(e,this._maxBoxesPointsPerDraw+B.MAX_BOXES_POINTS_INCREMENT),b=this._maxBoxesPerDraw-1))),p.children&&(this._drawWebGLKids(p.children,e,a),b=this._maxBoxesPerDraw-1));i||this._drawToGPU(e)},t._drawToGPU=function(t){var e;this._drawTexture&&(e=this._currentBoxIndex+1,t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._drawTexture),t.uniform1i(this._shaderProgram.sampler0uniform,0),t.bindBuffer(t.ARRAY_BUFFER,this._verticesBuffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._indicesBuffer),t.uniformMatrix3fv(this._shaderProgram.pMatrixUniform,!1,this._projectionMatrix),t.bufferSubData(t.ARRAY_BUFFER,0,this._vertices),t.drawElements(t.TRIANGLES,e*B.INDICES_PER_BOX,t.UNSIGNED_SHORT,0),this._currentBoxIndex=-1,this._drawTexture=null)},createjs.SpriteStage=createjs.promote(B,"Stage")}();